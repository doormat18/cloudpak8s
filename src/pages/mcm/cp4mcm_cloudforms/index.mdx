# RedHat CloudForms 5.0 installation for Cloud Pak for MultiCloud Management 1.3

## Required files

The files from Passport Advantage site for RedHat CloudForms 5 are:

* Red Hat CloudForms 5 for for IBM Cloud App Management 20.0.1 Multiplatform English eAssembly (CJ78FEN)

It contains the disk image of RedHat CloudForms 5 appliance in various platforms and the integration to IBM Cloud Pak for MultiCloud Management 1.3.
Other formats such as AWS and Azure disk images are available from RedHat in [https://access.redhat.com/products/red-hat-cloudforms/](https://access.redhat.com/products/red-hat-cloudforms/).



## Initialize CloudForms server

Follow the instructions for restoring RedHat CloudForms 5 appliance from: [https://access.redhat.com/documentation/en-US/Red_Hat_CloudForms/5.0/](https://access.redhat.com/documentation/en-US/Red_Hat_CloudForms/5.0/).

The following summary steps are demonstrating RedHat CloudForms 5 appliance to Amazon AWS.

1. Using the image `cfme-ec2-5.11.4.2-1.x86_64.zip` extract the vhd file:

  ```
  unzip cfme-ec2-5.11.4.2-1.x86_64.zip
  ```

  And store the VHD file into an S3 bucket, (such as `rh-cloudforms5`)

  ```
  aws s3 cp cfme-ec2-5.11.4.2-1.x86_64.vhd s3://rh-cloudforms5
  ```

2. Creating the vmimport role for loading an disk snapshot to AWS.

  - trust-policy.json

  ```json
  {
     "Version": "2012-10-17",
     "Statement": [
        {
           "Effect": "Allow",
           "Principal": { "Service": "vmie.amazonaws.com" },
           "Action": "sts:AssumeRole",
           "Condition": {
              "StringEquals":{
                 "sts:Externalid": "vmimport"
              }
           }
        }
     ]
  }
  ```

  - role-policy.json (change the S3 bucket name to the name you use before)

  ```
  {
   "Version": "2012-10-17",
   "Statement": [
     {
       "Effect": "Allow",
       "Action": [
         "s3:ListAllMyBuckets"
       ],
       "Resource": "*"
     },
     {
       "Effect": "Allow",
       "Action": [
         "s3:CreateBucket",
         "s3:DeleteBucket",
         "s3:DeleteObject",
         "s3:GetBucketLocation",
         "s3:GetObject",
         "s3:ListBucket",
         "s3:PutObject"
       ],
       "Resource": ["arn:aws:s3:::BUCKET_TO_UPLOAD_IMAGE","arn:aws:s3:::BUCKET_TO_UPLOAD_IMAGE/*"]
     },
     {
       "Effect": "Allow",
       "Action": [
         "iam:CreateRole",
         "iam:PutRolePolicy"
       ],
       "Resource": "*"
     },
     {
       "Effect": "Allow",
       "Action": [
         "ec2:CancelConversionTask",
         "ec2:CancelExportTask",
         "ec2:CreateImage",
         "ec2:CreateInstanceExportTask",
         "ec2:CreateTags",
         "ec2:DeleteTags",
         "ec2:DescribeConversionTasks",
         "ec2:DescribeExportTasks",
         "ec2:DescribeExportImageTasks",
         "ec2:DescribeInstanceAttribute",
         "ec2:DescribeInstanceStatus",
         "ec2:DescribeInstances",
         "ec2:DescribeTags",
         "ec2:ExportImage",
         "ec2:ImportInstance",
         "ec2:ImportVolume",
         "ec2:StartInstances",
         "ec2:StopInstances",
         "ec2:TerminateInstances",
         "ec2:ImportImage",
         "ec2:ImportSnapshot",
         "ec2:DescribeImportImageTasks",
         "ec2:DescribeImportSnapshotTasks",
         "ec2:CancelImportTask"
       ],
       "Resource": "*"
     }
   ]
  }
  ```

  Create the vmimport role:

  ```
  aws iam create-role --role-name vmimport --assume-role-policy-document file://trust-policy.json
  aws iam put-role-policy --role-name vmimport --policy-name vmimport --policy-document file://role-policy.json
  ```

3. Load the snapshot using the file container.json:

  ```json
  {
    "Description": "RedHat CloudForms 5",
    "Format": "vhd",
    "UserBucket": {
        "S3Bucket": "BUCKET WITH UPLOADED .VHD IMAGE",
        "S3Key": "cfme-ec2-5.11.4.2-1.x86_64.vhd"
    }
  }
  ```

  Run the load:
  ```
  aws ec2 import-snapshot --disk-container file://containers.json
  ```

4. Once the load is completed (check using `aws ec2 describe-import-snapshot-tasks --import-task-ids < task id >`)
  Run `aws ec2 register-image` or use the Web UI to create new AMI from Snapshot that you uploaded.

5. Create a Security group that will allow access to port 22 (ssh) and port 443 (https); Use the security group for launching and instance of RedHat CloudForms 5. Make sure you allocate an additional disk for the PostgreSQL database.

6. Use a terminal window to SSH into the CloudForms instance; initialize the server, the process below are using an embedded PostgreSQL database for a standalone CloudForms server.

  * Login to the appliance
  * Run `appliance_console` command
  * Select option `[5] Configure Database` > `[1] Create key` > '[1] Create Internal Database' > `[1] /dev/xvdb`
  * Answer **`N`** for `Should this appliance run as a standalone database server?`
  * Assign a postgreSQL password and verify
  * Answer `0` for the database region number
  * Wait until the database is initialized
  * Back in the main menu, select `[14] Start CFME server` and then `[19] Exit`

7. Try logging into the CloudForms server using port 443 and login as `admin` and password of `smartvm`

## Integrated CloudForms server with Cloud Pak for MultiCloud Management

1. Download the script

2. Create a file registration.json:

  ```json
  {
    "token_endpoint_auth_method":"client_secret_basic",
    "client_id": "<CLIENT_ID>",
    "client_secret": "<CLIENT_SECRET>",
    "scope":"openid profile email",
    "grant_types":[
       "authorization_code",
       "client_credentials",
       "password",
       "implicit",
       "refresh_token",
       "urn:ietf:params:oauth:grant-type:jwt-bearer"
    ],
    "response_types":[
       "code",
       "token",
       "id_token token"
    ],
    "application_type":"web",
    "subject_type":"public",
    "post_logout_redirect_uris":[
       "https://<ICP_PROXY_IP>:<PORT_WHERE_SERVICE_RUNS>"   ],
    "preauthorized_scope":"openid profile email general",
    "introspect_tokens":true,
    "trusted_uri_prefixes":[
       "https://<ICP_ENDPOINT>:<port>", "https://<ICP_PROXY_IP>"    ],
    "redirect_uris":["https://<ICP_PROXY_IP>:<PORT_WHERE_SERVICE_RUNS>/auth/liberty/callback"]
    }
    ```

    Run
    ```bash
    cloudctl iam oauth-client-register -f registration.json
    ```

3. Extract MCM certificate and save it as a TRUSTED certificate

    ```bash
    kubectl get secret -n kube-public ibmcloud-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 --decode | sed 's/CERTIFICATE/TRUSTED CERTIFICATE/' > ibm-mcm-ca.crt
    ```

4. Copy the ibm-mcm-ca.crt to the CloudForms machine in the path of `/etc/pki/ca-trust/source/anchors` and run `update-ca-trust`

5. Restart the CloudForms engine `systemctl restart evmserverd`

6. Run the following commands to copy oidc configurations:

    ```bash
    #TEMPLATE_DIR="/opt/rh/cfme-appliance/TEMPLATE"
# cp ${TEMPLATE_DIR}/etc/httpd/conf.d/manageiq-remote-user-openidc.conf \
    /etc/httpd/conf.d/
# cp ${TEMPLATE_DIR}/etc/httpd/conf.d/manageiq-external-auth-openidc.conf.erb \
    /etc/httpd/conf.d/manageiq-external-auth-openidc.conf
    ```


7. Update

  ```
  LoadModule          auth_openidc_module modules/mod_auth_openidc.so
ServerName          https://<cf_hostname>

OIDCCLientID                  <CLIENT_ID>
OIDCClientSecret              <CLIENT_SECRET>
OIDCRedirectURI                https://<cf_hostname>/oidc_login/redirect_uri
OIDCCryptoPassphrase           <passphrase>
OIDCOAuthRemoteUserClaim       sub
OIDCRemoteUserClaim            name

OIDCProviderIssuer                  https://127.0.0.1:443/idauth/oidc/endpoint/OP
OIDCProviderAuthorizationEndpoint   https://<mcm_console_url>/idprovider/v1/auth/authorize
OIDCProviderTokenEndpoint           https://<mcm_console_url>/idprovider/v1/auth/token
OIDCOAuthIntrospectionEndpoint      https://<mcm_console_url>/idprovider/v1/auth/introspect
OIDCProviderJwksUri                 https://<mcm_console_url>/oidc/endpoint/OP/jwk
OIDCProviderEndSessionEndpoint      https://<mcm_console_url>/idprovider/v1/auth/logout

OIDCScope                        "openid email profile"
OIDCResponseMode                 "query"
OIDCProviderTokenEndpointAuth     client_secret_post

OIDCPassUserInfoAs json
OIDCSSLValidateServer off
OIDCHTTPTimeoutShort 10

<Location /oidc_login>
  AuthType  openid-connect
  Require   valid-user
  LogLevel   warn
</Location>
```

8. Restart httpd: `systemctl restart httpd`

9. Log in as admin, then select the Configuration by clicking the gear icon.

10. Select the Settings, then select the Authentication tab.

11. In the Authentication section, set the Mode to External (httpd)

12. In the External Authentication (httpd) Settings section, set Provider Type to Enable OpenID-Connect.

    Note: This setting enables the OIDC login button on the login screen, that redirects to the OIDC protected page for authentication, and supports the OIDC logout process.
    Optional: In the External Authentication (httpd) Settings section, select Enable Single Sign-On.

    Note: If you select this option, the initial access to the Appliance Administrative UI will redirect to the OIDC Identity Provider authentication screen.

13. In the Role Settings section, select the Get User Groups from External Authentication (httpd) setting.

14. Select Access Control and make sure the userâ€™s groups are created on the Appliance and appropriate roles assigned to those groups.

15. Click Save.
